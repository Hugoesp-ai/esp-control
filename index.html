<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>ESP32 Control</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<style>
body{background:#111;color:#fff;font-family:Arial;text-align:center}
button{padding:12px;margin:5px;border-radius:10px;border:none}
.on{background:#00c853}
.off{background:#d50000}
</style>
</head>
<body>

<h1>ğŸŒ± Greenhouse</h1>

<div id="buttons"></div>

<h2>Capteurs</h2>
<p>ğŸŒ± Soil: <span id="soil">--</span></p>
<p>ğŸŒ¡ï¸ Temp: <span id="temp">--</span> Â°C</p>
<p>ğŸ’§ Hum: <span id="hum">--</span> %</p>
<p>ğŸ« COâ‚‚: <span id="co2">--</span> ppm</p>

<button id="cal">Calibrer COâ‚‚ (3s)</button>
<p id="status"></p>

<script>
const client = mqtt.connect("wss://92fa7388d5834bffa514b462e7b817fa.s1.eu.hivemq.cloud:8884/mqtt",{
  username:"Hugoesp",password:"Kikoloki1"
});

const relays = [
 ["Remplissage","esp32/remplissage/cmd"],
 ["Pompe","esp32/pompe/cmd"],
 ["Brassage","esp32/brassage/cmd"],
 ["Arrosage","esp32/arrosage/cmd"]
];

const btnDiv = document.getElementById("buttons");

relays.forEach(r=>{
  btnDiv.innerHTML += `
  <button class="on" onclick="send('${r[1]}','ON')">${r[0]} ON</button>
  <button class="off" onclick="send('${r[1]}','OFF')">${r[0]} OFF</button><br>`;
});

function send(topic,msg){client.publish(topic,msg)}

client.subscribe("esp32/#");

client.on("message",(t,m)=>{
  const v=m.toString();
  if(t.includes("soil")) soil.innerText=v;
  if(t.includes("temp")) temp.innerText=v;
  if(t.includes("hum")) hum.innerText=v;
  if(t.includes("co2/ppm")) co2.innerText=v;
  if(t.includes("status")) status.innerText="Calibration OK âœ…";
});

let timer;
cal.onmousedown=()=>{timer=setTimeout(()=>send("esp32/co2/calibrate","START"),3000)}
cal.onmouseup=()=>clearTimeout(timer);
</script>

</body>
</html>
